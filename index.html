<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo de Xadrez Multiplayer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        h1 {
            margin-bottom: 20px;
        }
        #board {
            display: grid;
            grid-template-columns: repeat(8, 60px);
            grid-template-rows: repeat(8, 60px);
            gap: 2px;
            border: 2px solid #333;
        }
        .square {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            user-select: none;
        }
        .square.light {
            background-color: #f0d9b5;
        }
        .square.dark {
            background-color: #b58863;
        }
        .piece {
            font-size: 40px;
            cursor: grab;
        }
        #resetButton {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
        }
        #resetButton:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <h1>Jogo de Xadrez Multiplayer</h1>
    <div id="board"></div>
    <button id="resetButton">Reiniciar</button>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const firebaseConfig = {
                apiKey: "AIzaSyBdpllrJMyygX7rnghGoCg2C48g-R1wmvI",
                authDomain: "chess-app-4d926.firebaseapp.com",
                databaseURL: "https://chess-app-4d926-default-rtdb.firebaseio.com/",
                projectId: "chess-app-4d926",
                storageBucket: "chess-app-4d926.appspot.com",
                messagingSenderId: "352952439002",
                appId: "1:352952439002:web:9673d5bc928bdd9b0d95e3"
            };

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.database();
            const tg = window.Telegram.WebApp;
            tg.expand();

            const boardElement = document.getElementById('board');
            let selectedPiece = null;
            let selectedSquare = null;
            let gameRef = db.ref('games/default');
            let turnRef = gameRef.child('turn');
            let currentPlayer = 'white';

            // Estado inicial do tabuleiro
            const initialBoard = {
                "0": ["♜", "♞", "♝", "♛", "♚", "♝", "♞", "♜"],
                "1": ["♟", "♟", "♟", "♟", "♟", "♟", "♟", "♟"],
                "2": ["", "", "", "", "", "", "", ""],
                "3": ["", "", "", "", "", "", "", ""],
                "4": ["", "", "", "", "", "", "", ""],
                "5": ["", "", "", "", "", "", "", ""],
                "6": ["♙", "♙", "♙", "♙", "♙", "♙", "♙", "♙"],
                "7": ["♖", "♘", "♗", "♕", "♔", "♗", "♘", "♖"]
            };

            function createBoard(boardState) {
                boardElement.innerHTML = '';
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const square = document.createElement('div');
                        square.classList.add('square', (row + col) % 2 === 0 ? 'light' : 'dark');
                        square.dataset.row = row;
                        square.dataset.col = col;
                        
                        const piece = boardState[row][col];
                        if (piece) {
                            const pieceElement = document.createElement('div');
                            pieceElement.classList.add('piece');
                            pieceElement.textContent = piece;
                            pieceElement.dataset.row = row;
                            pieceElement.dataset.col = col;
                            square.appendChild(pieceElement);
                        }

                        square.addEventListener('click', () => handleSquareClick(row, col));
                        boardElement.appendChild(square);
                    }
                }
            }

            function handleSquareClick(row, col) {
                turnRef.once('value', snapshot => {
                    const turn = snapshot.val();
                    if (turn !== currentPlayer) return; // Bloqueia movimentos do jogador errado

                    const square = document.querySelector(`.square[data-row="${row}"][data-col="${col}"]`);
                    const piece = square.querySelector('.piece');
                    
                    if (selectedPiece) {
                        const fromRow = parseInt(selectedPiece.dataset.row);
                        const fromCol = parseInt(selectedPiece.dataset.col);
                        
                        gameRef.child(`board/${row}/${col}`).set(selectedPiece.textContent);
                        gameRef.child(`board/${fromRow}/${fromCol}`).set("");
                        selectedPiece = null;
                        selectedSquare.classList.remove('selected');
                        selectedSquare = null;
                        
                        turnRef.set(turn === 'white' ? 'black' : 'white');
                    } else if (piece) {
                        selectedPiece = piece;
                        selectedSquare = square;
                        square.classList.add('selected');
                    }
                });
            }

            function resetBoard() {
                gameRef.child('board').set(initialBoard);
                turnRef.set('white');
            }

            // Inicializa o tabuleiro com o estado inicial
            gameRef.child('board').once('value', snapshot => {
                if (!snapshot.exists()) {
                    resetBoard();
                }
            });

            gameRef.child('board').on('value', snapshot => {
                if (snapshot.exists()) {
                    const boardState = snapshot.val();
                    createBoard(boardState);
                }
            });

            document.getElementById('resetButton').addEventListener('click', resetBoard);
        });
    </script>
</body>
</html>
